<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" />
  <title>ProgressFit</title>

  <!-- PWA / icons -->
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="apple-touch-icon" href="apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="ProgressFit" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --bg:#0b1220;
      --border: rgba(255,255,255,.08);
      --text:#e8eefc;
      --muted:#9fb0d6;
      --good:#7CFF8C;
      --bad:#ff6a7a;
      --radius:16px;
      --shadow: 0 18px 60px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans","Noto Sans JP",Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(1200px 800px at 30% -10%, rgba(106,227,255,.18), transparent 55%),
        radial-gradient(900px 700px at 110% 10%, rgba(167,139,250,.18), transparent 60%),
        var(--bg);
      padding: 14px 12px 14px;
    }
    .phone{
      max-width: 430px;
      margin: 0 auto;
      min-height: calc(100dvh - 28px);
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .top{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .brand{display:flex; gap:10px; align-items:center; min-width:0}
    .logo{
      width:40px; height:40px; border-radius:14px;
      background:linear-gradient(135deg,rgba(106,227,255,.28),rgba(167,139,250,.22));
      box-shadow:var(--shadow);
      flex:0 0 auto;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .logo.spinning{
      animation: spin 0.9s linear infinite;
      filter: brightness(1.08);
    }
    @keyframes spin{
      from{ transform: rotate(0deg); }
      to{ transform: rotate(360deg); }
    }

    .titlewrap{min-width:0}
    .title{font-size:18px; font-weight:900; margin:0; line-height:1.2}
    .sub{font-size:12px; color:var(--muted); margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

    .actions{display:flex; gap:8px; align-items:center; flex:0 0 auto}
    .chip{
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      border-radius:999px;
      padding:8px 10px;
      font-size:12px;
      font-weight:900;
      line-height:1;
      user-select:none;
    }
    .chip b{color:var(--text)}
    .chipBtn{
      cursor:pointer;
      color: var(--text);
      background: rgba(106,227,255,.12);
      border-color: rgba(106,227,255,.22);
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    .chipBtn.disabled{
      opacity: .55;
      pointer-events:none;
    }

    .seg{
      display:flex;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius:999px;
      padding:6px;
      gap:6px;
    }
    .seg button{
      border:0; background:transparent;
      color:var(--muted);
      font-weight:900;
      padding:10px 12px;
      border-radius:999px;
      cursor:pointer;
      line-height:1;
      flex:1;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    .seg button.active{
      color:var(--text);
      background: rgba(106,227,255,.18);
    }

    .kpis{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .kpi{
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border-radius: var(--radius);
      padding:12px;
      box-shadow: var(--shadow);
      min-height:86px;
    }
    .khead{display:flex; justify-content:space-between; align-items:baseline; gap:8px}
    .klabel{font-size:12px;color:var(--muted);font-weight:900}
    .kdelta{font-size:12px;font-weight:950}
    .kval{display:flex; align-items:baseline; gap:8px; margin-top:6px}
    .knum{font-size:26px;font-weight:1000; letter-spacing:.2px}
    .kunit{font-size:12px;color:var(--muted);font-weight:900}

    .panel{
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border-radius: var(--radius);
      padding:10px;
      box-shadow: var(--shadow);
      flex:1;
      display:flex;
      flex-direction:column;
      min-height: 0;
    }

    .tabs{
      display:flex; gap:6px; flex-wrap:wrap;
      margin-bottom:6px;
    }
    .tab{
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      border-radius:999px;
      padding:8px 10px;
      font-size:12px;
      font-weight:900;
      cursor:pointer;
      line-height:1;
      user-select:none;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    .tab.active{
      color: var(--text);
      background: rgba(167,139,250,.16);
      border-color: rgba(167,139,250,.30);
    }

    #metricTitle{
      display:none;
      font-size:14px;
      font-weight:1000;
      margin: 2px 0 6px;
      color: var(--text);
    }

    .chartWrap{ position:relative; flex:1; min-height:0; }
    #trendView{ padding-bottom: calc(30px + env(safe-area-inset-bottom)); }
    canvas{width:100% !important; height:100% !important}

    #moreView{ flex:1; min-height:0; overflow:auto; }

    .viewSeg{ margin-top:auto; }

    .moreGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      padding-top:4px;
    }

    .importExport{
      margin-top: 12px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .moreItem{
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius: 14px;
      padding:10px;
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    .moreName{font-size:12px;color:var(--muted);font-weight:900}
    .moreVal{margin-top:6px;font-size:18px;font-weight:1000}
    .moreUnit{font-size:12px;color:var(--muted);font-weight:900;margin-left:6px}
    .hint{font-size:12px;color:var(--muted);margin-top:10px;line-height:1.4}

    .modalBg{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index: 50;
    }
    .modal{
      width:min(430px, 100%);
      border:1px solid var(--border);
      background: rgba(12,18,32,.92);
      backdrop-filter: blur(10px);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding:14px;
    }
    .mTitle{font-size:14px;font-weight:1000;margin:2px 0 10px}
    .form{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .field{
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius: 14px;
      padding:10px;
    }
    .field.full{ grid-column: 1 / -1; }
    .field label{display:block;font-size:12px;color:var(--muted);font-weight:900;margin-bottom:6px}
    .field input{
      width:100%;
      border:0;
      outline:none;
      background: transparent;
      color: var(--text);
      font-size:16px;
      font-weight:950;
    }
    .mActions{display:flex; gap:8px; justify-content:flex-end; margin-top:12px}
    .btn{
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--text);
      border-radius: 999px;
      padding:10px 12px;
      font-weight:950;
      cursor:pointer;
      line-height:1;
      user-select:none;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    .btnPrimary{
      background: rgba(106,227,255,.14);
      border-color: rgba(106,227,255,.30);
    }
    .btnDanger{
      background: rgba(255,106,122,.12);
      border-color: rgba(255,106,122,.25);
    }

    .listRow{
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius:12px;
      padding:10px;
      margin-bottom:8px;
      display:flex;
      justify-content:space-between;
      gap:10px;
    }
    .listMain{font-size:13px; line-height:1.4}
    .listDate{font-weight:1000}
    .listSub{color:var(--muted); font-size:12px}
    .listActions{display:flex; align-items:center}
    .listEdit{
      border:0;
      background: rgba(106,227,255,.15);
      color: var(--text);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }

    .safeBottom{height: env(safe-area-inset-bottom);}
  </style>
</head>

<body>
<div class="phone">
  <div class="top">
    <div class="brand">
      <div class="logo" id="logoBtn" title="更新"></div>
      <div class="titlewrap">
        <div class="title">ProgressFit</div>
        <div class="sub" id="subtitle">Loading…</div>
      </div>
    </div>
    <div class="actions">
      <div class="chip chipBtn" id="countChip">件数 <b id="count">0</b></div>
      <div class="chip chipBtn" id="openTargets">目標</div>
      <div class="chip chipBtn" id="openAdd">＋データ</div>
    </div>
  </div>

  <div class="seg" id="rangeSeg">
    <button class="active" data-range="all">全期間</button>
    <button data-range="1y">1年</button>
    <button data-range="3m">3ヶ月</button>
  </div>

  <div class="kpis">
    <div class="kpi">
      <div class="khead"><div class="klabel">体重</div><div class="kdelta" id="d_weight">—</div></div>
      <div class="kval"><div class="knum" id="k_weight">—</div><div class="kunit">kg</div></div>
    </div>
    <div class="kpi">
      <div class="khead"><div class="klabel">体脂肪率</div><div class="kdelta" id="d_bf">—</div></div>
      <div class="kval"><div class="knum" id="k_bf">—</div><div class="kunit">%</div></div>
    </div>
    <div class="kpi">
      <div class="khead"><div class="klabel">体脂肪量</div><div class="kdelta" id="d_fm">—</div></div>
      <div class="kval"><div class="knum" id="k_fm">—</div><div class="kunit">kg</div></div>
    </div>
    <div class="kpi">
      <div class="khead"><div class="klabel">骨格筋量</div><div class="kdelta" id="d_smm">—</div></div>
      <div class="kval"><div class="knum" id="k_smm">—</div><div class="kunit">kg</div></div>
    </div>
  </div>

  <div class="panel">
    <div id="metricTitle"></div>

    <div class="tabs" id="metricTabs">
      <div class="tab active" data-m="weight_kg">体重</div>
      <div class="tab" data-m="bodyfat_pct">体脂肪率</div>
      <div class="tab" data-m="fatmass_kg">体脂肪量</div>
      <div class="tab" data-m="skeletal_muscle_kg">骨格筋量</div>
    </div>

    <div class="chartWrap" id="trendView">
      <canvas id="trend"></canvas>
    </div>

    <div class="chartWrap" id="bodyMapView" style="display:none;">
      <canvas id="bodymap"></canvas>
    </div>

    <div id="moreView" style="display:none;">
      <div class="moreGrid" id="moreGrid"></div>

      <div class="importExport">
        <div class="chip chipBtn" id="exportCsvBtn">CSV出力</div>
        <div class="chip chipBtn" id="importCsvBtn">CSV取込</div>
        <div class="chip chipBtn" id="exportPdfBtn">PDF出力</div>
        <input type="file" id="importCsvInput" accept=".csv" style="display:none;">
      </div>

      <div class="hint">
        ※データの正はGoogle Sheet。追加/更新/削除は即時Sheetに反映されます。<br/>
        ※CSV取込はSheet全置換（replace）です。
      </div>
    </div>

    <div class="seg viewSeg" id="viewSeg">
      <button class="active" data-view="trend">Trend</button>
      <button data-view="bodymap">BodyMap</button>
      <button data-view="more">More</button>
    </div>
  </div>

  <div class="safeBottom"></div>
</div>

<!-- Targets Modal -->
<div class="modalBg" id="modalTargetsBg">
  <div class="modal">
    <div class="mTitle">目標値（端末に保存）</div>
    <div class="form">
      <div class="field">
        <label>体重 目標 (kg)</label>
        <input id="t_weight" inputmode="decimal" />
      </div>
      <div class="field">
        <label>体脂肪率 目標 (%)</label>
        <input id="t_bf" inputmode="decimal" />
      </div>
      <div class="field">
        <label>体脂肪量 目標 (kg)</label>
        <input id="t_fm" inputmode="decimal" />
      </div>
      <div class="field">
        <label>骨格筋量 目標 (kg)</label>
        <input id="t_smm" inputmode="decimal" />
      </div>
      <div class="field full">
        <label>身長 (cm) ※BMI自動計算に使う（任意）</label>
        <input id="t_height" inputmode="decimal" placeholder="例: 175" />
      </div>
    </div>
    <div class="mActions">
      <button class="btn" id="closeTargets">キャンセル</button>
      <button class="btn btnPrimary" id="saveTargets">保存</button>
    </div>
  </div>
</div>

<!-- Add/Edit Modal -->
<div class="modalBg" id="modalAddBg">
  <div class="modal">
    <div class="mTitle" id="addTitle">データ追加</div>
    <div class="form">
      <div class="field full">
        <label>測定日</label>
        <input id="a_date" type="date" />
      </div>

      <div class="field">
        <label>体重 (kg) ※必須</label>
        <input id="a_weight" inputmode="decimal" />
      </div>
      <div class="field">
        <label>体脂肪率 (%) ※必須</label>
        <input id="a_bf" inputmode="decimal" />
      </div>

      <div class="field">
        <label>体脂肪量 (kg) ※必須</label>
        <input id="a_fm" inputmode="decimal" />
      </div>
      <div class="field">
        <label>骨格筋量 (kg) ※必須</label>
        <input id="a_smm" inputmode="decimal" />
      </div>

      <div class="field">
        <label>筋肉量 (kg)</label>
        <input id="a_mu" inputmode="decimal" placeholder="任意" />
      </div>
      <div class="field">
        <label>内臓脂肪レベル</label>
        <input id="a_vfl" inputmode="decimal" placeholder="任意" />
      </div>

      <div class="field">
        <label>BMI（空なら身長から計算）</label>
        <input id="a_bmi" inputmode="decimal" placeholder="任意" />
      </div>
    </div>

    <div class="hint">※必須：測定日 / 体重 / 体脂肪率 / 体脂肪量 / 骨格筋量（BMIは身長があれば自動）</div>

    <div class="mActions">
      <button class="btn" id="closeAdd">キャンセル</button>
      <button class="btn btnDanger" id="deleteOne" style="display:none;">この1件を削除</button>
      <button class="btn btnPrimary" id="saveAdd">保存</button>
    </div>
  </div>
</div>

<!-- List Modal -->
<div class="modalBg" id="modalListBg">
  <div class="modal">
    <div class="mTitle">記録一覧</div>
    <div id="listWrap" style="max-height:60vh;overflow:auto;"></div>
    <div class="mActions">
      <button class="btn" id="closeList">閉じる</button>
    </div>
  </div>
</div>

<script>
/* =========================
   GAS settings
   ========================= */
const SHEET_ENDPOINT = 'https://script.google.com/macros/s/AKfycbw9CtTfhzsc7ZMDPvHQXcVDl5dSBwnkBS7eqkiL135vLPowX1lus2IRgsQlX2QY73bXtA/exec';
const SHEET_TOKEN = 'aP7Z9XQ2K5R8H4mE';
  
/* =========================
   configs
   ========================= */
const METRICS = {
  weight_kg:           { name:'体重', unit:'kg' },
  bodyfat_pct:         { name:'体脂肪率', unit:'%'  },
  fatmass_kg:          { name:'体脂肪量', unit:'kg' },
  skeletal_muscle_kg:  { name:'骨格筋量', unit:'kg' },

  muscle_kg:           { name:'筋肉量', unit:'kg'  },
  bmi:                 { name:'BMI', unit:''       },
  visceral_fat_level:  { name:'内臓脂肪', unit:'lv' },
};
const MAIN_METRICS = ['weight_kg','bodyfat_pct','fatmass_kg','skeletal_muscle_kg'];

/* =========================
   storage keys
   ========================= */
const TARGET_KEY  = 'progressfit_targets_sheet_v1';

/* =========================
   utils
   ========================= */
const $ = (id)=>document.getElementById(id);

function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

function normalizeYMD(v){
  const s = String(v ?? '').trim();
  if(!s) return '';
  if(s.includes('T')) return s.slice(0,10);
  if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
  const d = new Date(s);
  if(!isNaN(d.getTime())){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${dd}`;
  }
  return s;
}

function fmt1(x){ return Number.isFinite(x) ? (Math.round(x*10)/10).toFixed(1) : '—'; }
function numOrNull(v){
  if(v===undefined || v===null) return null;
  const s = String(v).trim();
  if(s === '') return null;
  const n = Number(s);
  return Number.isFinite(n) ? n : null;
}
function parseDateLocal(ymd){
  const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(String(ymd||''));
  if(!m) return null;
  return new Date(Number(m[1]), Number(m[2])-1, Number(m[3]));
}
function setDelta(el, v, goodWhenDecrease){
  if(!Number.isFinite(v)){ el.textContent='—'; el.style.color='var(--muted)'; return; }
  const r = Math.round(v*10)/10;
  el.textContent = (r>0?'+':'') + r.toFixed(1);
  const good = goodWhenDecrease ? (r<0) : (r>0);
  el.style.color = good ? 'var(--good)' : 'var(--bad)';
}

/* busy UI */
let busyCount = 0;
function setBusy(on, label){
  busyCount += on ? 1 : -1;
  if(busyCount < 0) busyCount = 0;

  const isBusy = busyCount > 0;
  const logo = $('logoBtn');
  logo.classList.toggle('spinning', isBusy);

  ['countChip','openTargets','openAdd','exportCsvBtn','importCsvBtn','exportPdfBtn'].forEach(id=>{
    const el = $(id);
    if(!el) return;
    el.classList.toggle('disabled', isBusy);
  });

  if(label){
    $('subtitle').textContent = label;
  }
}
async function withBusy(label, fn, minMs=250){
  const start = Date.now();
  setBusy(true, label);
  try{
    return await fn();
  }finally{
    const elapsed = Date.now() - start;
    if(elapsed < minMs) await sleep(minMs - elapsed);
    setBusy(false);
  }
}

/* =========================
   targets (local only)
   ========================= */
const defaultTargets = {
  weight_kg: 75.0,
  bodyfat_pct: 20.0,
  fatmass_kg: 16.0,
  skeletal_muscle_kg: 30.0,
  height_cm: null
};
let targets = loadTargets();

function loadTargets(){
  try{
    const raw = localStorage.getItem(TARGET_KEY);
    return raw ? { ...defaultTargets, ...JSON.parse(raw) } : { ...defaultTargets };
  }catch(e){ return { ...defaultTargets }; }
}
function saveTargets(){ localStorage.setItem(TARGET_KEY, JSON.stringify(targets)); }

function computeBmiFromHeight(weightKg){
  const h = targets.height_cm ? (+targets.height_cm/100) : null;
  if(!h || !Number.isFinite(weightKg)) return null;
  return weightKg / (h*h);
}
function getMetricValue(row, key){
  if(Number.isFinite(row[key])) return row[key];
  if(key === 'bmi'){
    const calc = computeBmiFromHeight(row.weight_kg);
    return Number.isFinite(calc) ? calc : null;
  }
  return null;
}

/* =========================
   GAS I/O
   ========================= */
function jsonpGet(url){
  return new Promise((resolve, reject)=>{
    const cb = 'pf_cb_' + Math.random().toString(36).slice(2);
    const script = document.createElement('script');

    window[cb] = (payload)=>{
      cleanup();
      resolve(payload);
    };

    function cleanup(){
      try{ delete window[cb]; }catch(e){ window[cb]=undefined; }
      if(script.parentNode) script.parentNode.removeChild(script);
    }

    script.onerror = ()=>{ cleanup(); reject(new Error('jsonp error')); };
    script.src = `${url}&callback=${encodeURIComponent(cb)}&_=${Date.now()}`;
    document.body.appendChild(script);
  });
}

async function postToGAS(params){
  const body = new URLSearchParams({ token: SHEET_TOKEN, ...params });
  await fetch(SHEET_ENDPOINT, { method:'POST', mode:'no-cors', body });
}

function toRowsFromSheet(header, rowsArr){
  const idx = Object.fromEntries(header.map((h,i)=>[String(h), i]));
  const pick = (r, key)=> (idx[key]===undefined ? null : r[idx[key]]);
  return rowsArr.map(r=>({
    date: normalizeYMD(pick(r,'date')),
    weight_kg: numOrNull(pick(r,'weight_kg')),
    bodyfat_pct: numOrNull(pick(r,'bodyfat_pct')),
    fatmass_kg: numOrNull(pick(r,'fatmass_kg')),
    skeletal_muscle_kg: numOrNull(pick(r,'skeletal_muscle_kg')),
    muscle_kg: numOrNull(pick(r,'muscle_kg')),
    bmi: numOrNull(pick(r,'bmi')),
    visceral_fat_level: numOrNull(pick(r,'visceral_fat_level')),
    fitness_score: numOrNull(pick(r,'fitness_score'))
  })).filter(x=>x.date).sort((a,b)=>a.date.localeCompare(b.date));
}

/* =========================
   state
   ========================= */
let rows = [];
let currentRange = 'all';
let currentMetric = 'weight_kg';
let currentView = 'trend'; // trend | bodymap | more
let showMetricTabs = true;

let trendChart = null;
let bodyMapChart = null;

let editMode = false;
let editOriginalDate = null;

/* =========================
   range filter
   ========================= */
function filt(){
  if(!rows.length) return [];
  if(currentRange==='all') return rows;

  const end = parseDateLocal(rows.at(-1).date);
  if(!end) return rows;

  const d = new Date(end);
  if(currentRange==='1y') d.setFullYear(d.getFullYear()-1);
  if(currentRange==='3m') d.setMonth(d.getMonth()-3);

  return rows.filter(r=>{
    const rd = parseDateLocal(r.date);
    return rd && rd >= d;
  });
}

/* =========================
   chart plugins
   ========================= */
const targetLinePlugin = {
  id: 'targetLine',
  afterDatasetsDraw(chart){
    const t = targets[currentMetric];
    if(t === undefined || t === null || Number.isNaN(+t)) return;
    const y = chart.scales.y.getPixelForValue(+t);
    const {left,right,top,bottom} = chart.chartArea;
    if(y < top || y > bottom) return;

    const ctx = chart.ctx;
    ctx.save();
    ctx.strokeStyle = 'rgba(124,255,140,.75)';
    ctx.lineWidth = 1;
    ctx.setLineDash([6,6]);
    ctx.beginPath(); ctx.moveTo(left, y); ctx.lineTo(right, y); ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle = 'rgba(124,255,140,.9)';
    ctx.font = '12px -apple-system,BlinkMacSystemFont,"Hiragino Sans","Noto Sans JP",sans-serif';
    ctx.fillText('TARGET ' + (+t).toFixed(1), left+6, Math.max(top+14, y-6));
    ctx.restore();
  }
};

const bodyMapBg = {
  id: 'bodyMapBg',
  beforeDraw(chart){
    const {ctx, chartArea} = chart;
    if(!chartArea) return;
    const {left, right, top, bottom} = chartArea;

    ctx.save();
    ctx.fillStyle = 'rgba(255,255,255,0.02)';
    ctx.fillRect(left, top, right-left, bottom-top);

    const xScale = chart.scales.x;
    const yScale = chart.scales.y;

    const x = xScale.getPixelForValue(25);
    const y = yScale.getPixelForValue(25);

    ctx.strokeStyle = 'rgba(255,255,255,0.15)';
    ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(x, top); ctx.lineTo(x, bottom); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(left, y); ctx.lineTo(right, y); ctx.stroke();

    ctx.fillStyle = 'rgba(159,176,214,0.75)';
    ctx.font = '12px -apple-system,BlinkMacSystemFont,"Hiragino Sans","Noto Sans JP",sans-serif';
    ctx.fillText('BMI 25', x+6, top+16);
    ctx.fillText('BF 25%', left+6, y-8);

    const h = targets.height_cm ? (+targets.height_cm/100) : null;
    const targetBf = targets.bodyfat_pct;
    let targetBmi = null;
    if(h && Number.isFinite(+targets.weight_kg)) targetBmi = +targets.weight_kg/(h*h);

    if(Number.isFinite(targetBf) && Number.isFinite(targetBmi)){
      const tx = xScale.getPixelForValue(targetBmi);
      const ty = yScale.getPixelForValue(targetBf);
      ctx.fillStyle = 'rgba(124,255,140,0.9)';
      ctx.beginPath(); ctx.arc(tx, ty, 4, 0, Math.PI*2); ctx.fill();
      ctx.fillText('TARGET', tx+8, ty-8);
    }
    ctx.restore();
  }
};

/* =========================
   charts
   ========================= */
function ensureTrend(data){
  const labels = data.map(r=>r.date);
  const m = METRICS[currentMetric] || {name:currentMetric, unit:''};
  const values = data.map(r=>getMetricValue(r, currentMetric));
  const ctx = $('trend');

  if(!trendChart){
    trendChart = new Chart(ctx, {
      type:'line',
      data:{ labels, datasets:[{
        label: m.name + (m.unit?` (${m.unit})`:``),
        data: values,
        tension: .35,
        pointRadius: 2,
        pointHoverRadius: 5,
        borderWidth: 2,
        fill: false,
        spanGaps: true
      }]},
      options:{
        responsive:true,
        maintainAspectRatio:false,
        layout:{ padding:{ bottom: 8 } },
        plugins:{ legend:{display:false}, tooltip:{ mode:'index', intersect:false } },
        interaction:{ mode:'index', intersect:false },
        scales:{
          x:{ ticks:{ color:'#9fb0d6', maxRotation:0, autoSkip:true }, grid:{ color:'rgba(255,255,255,.06)' } },
          y:{ ticks:{ color:'#9fb0d6' }, grid:{ color:'rgba(255,255,255,.06)' } }
        }
      },
      plugins:[targetLinePlugin]
    });
  }else{
    trendChart.data.labels = labels;
    trendChart.data.datasets[0].data = values;
    trendChart.data.datasets[0].label = m.name + (m.unit?` (${m.unit})`:``);
    trendChart.update();
  }
}

function ensureBodyMap(data){
  const pts = data
    .map(r=>{
      const bmi = getMetricValue(r,'bmi');
      const bf  = getMetricValue(r,'bodyfat_pct');
      if(!Number.isFinite(bmi) || !Number.isFinite(bf)) return null;
      return {x:bmi, y:bf, d:r.date};
    })
    .filter(Boolean);

  const first = pts[0];
  const last = pts.at(-1);
  const ctx = $('bodymap');

  if(!bodyMapChart){
    bodyMapChart = new Chart(ctx, {
      type:'scatter',
      data:{ datasets:[
        { label:'推移', data:pts, pointRadius:3, pointHoverRadius:5 },
        { label:'開始', data:first?[first]:[], pointRadius:7, pointHoverRadius:8 },
        { label:'最新', data:last?[last]:[], pointRadius:7, pointHoverRadius:8 },
      ]},
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{
          legend:{ labels:{ color:'#e8eefc' } },
          tooltip:{ callbacks:{ label:(c)=>` BMI ${c.raw.x.toFixed(1)} / BF ${c.raw.y.toFixed(1)}% (${c.raw.d||''})` } }
        },
        scales:{
          x:{ title:{display:true,text:'BMI',color:'#9fb0d6'}, ticks:{ color:'#9fb0d6' }, grid:{ color:'rgba(255,255,255,.06)' } },
          y:{ title:{display:true,text:'体脂肪率(%)',color:'#9fb0d6'}, ticks:{ color:'#9fb0d6' }, grid:{ color:'rgba(255,255,255,.06)' } },
        }
      },
      plugins:[bodyMapBg]
    });
  }else{
    bodyMapChart.data.datasets[0].data = pts;
    bodyMapChart.data.datasets[1].data = first?[first]:[];
    bodyMapChart.data.datasets[2].data = last?[last]:[];
    bodyMapChart.update();
  }
}

/* =========================
   views
   ========================= */
function setView(v, via='direct'){
  currentView = v;

  if(v === 'trend'){
    if(via === 'direct') showMetricTabs = true;
  }else{
    showMetricTabs = false;
  }

  $('trendView').style.display   = (v==='trend') ? 'block' : 'none';
  $('bodyMapView').style.display = (v==='bodymap') ? 'block' : 'none';
  $('moreView').style.display    = (v==='more') ? 'block' : 'none';

  $('metricTabs').style.display  = (v==='trend' && showMetricTabs) ? 'flex' : 'none';
  $('metricTitle').style.display = (v==='trend' && !showMetricTabs) ? 'block' : 'none';

  document.querySelectorAll('#viewSeg button').forEach(b=>{
    b.classList.toggle('active', b.dataset.view===v);
  });

  render();
}

function getMoreMetrics(){
  const keys = Object.keys(METRICS);
  return keys.filter(k => !MAIN_METRICS.includes(k));
}

function renderMore(latest){
  const grid = $('moreGrid');
  grid.innerHTML = '';
  const moreKeys = getMoreMetrics();

  for(const key of moreKeys){
    const m = METRICS[key];
    const v = getMetricValue(latest, key);

    const item = document.createElement('div');
    item.className = 'moreItem';
    item.innerHTML = `
      <div class="moreName">${m.name}</div>
      <div class="moreVal">${fmt1(v)}${m.unit?`<span class="moreUnit">${m.unit}</span>`:''}</div>
    `;
    item.onclick = ()=>{
      currentMetric = key;
      document.querySelectorAll('#metricTabs .tab').forEach(t=>t.classList.remove('active'));
      $('metricTitle').textContent = m.name;
      setView('trend','fromMore');
    };
    grid.appendChild(item);
  }
}

function render(){
  const data = filt();
  $('count').textContent = data.length;

  if(!data.length){
    $('subtitle').textContent = 'No data';
    ['k_weight','k_bf','k_fm','k_smm'].forEach(id => $(id).textContent='—');
    ['d_weight','d_bf','d_fm','d_smm'].forEach(id => { $(id).textContent='—'; $(id).style.color='var(--muted)'; });

    if(trendChart){ trendChart.destroy(); trendChart = null; }
    if(bodyMapChart){ bodyMapChart.destroy(); bodyMapChart = null; }
    return;
  }

  $('subtitle').textContent = `${data[0].date} → ${data.at(-1).date}`;

  const start = data[0];
  const end = data.at(-1);

  const endW = getMetricValue(end,'weight_kg');
  const endB = getMetricValue(end,'bodyfat_pct');
  const endF = getMetricValue(end,'fatmass_kg');
  const endS = getMetricValue(end,'skeletal_muscle_kg');

  const stW = getMetricValue(start,'weight_kg');
  const stB = getMetricValue(start,'bodyfat_pct');
  const stF = getMetricValue(start,'fatmass_kg');
  const stS = getMetricValue(start,'skeletal_muscle_kg');

  $('k_weight').textContent = fmt1(endW);
  $('k_bf').textContent     = fmt1(endB);
  $('k_fm').textContent     = fmt1(endF);
  $('k_smm').textContent    = fmt1(endS);

  setDelta($('d_weight'), Number.isFinite(endW)&&Number.isFinite(stW) ? (endW - stW) : NaN, true);
  setDelta($('d_bf'),     Number.isFinite(endB)&&Number.isFinite(stB) ? (endB - stB) : NaN, true);
  setDelta($('d_fm'),     Number.isFinite(endF)&&Number.isFinite(stF) ? (endF - stF) : NaN, true);
  setDelta($('d_smm'),    Number.isFinite(endS)&&Number.isFinite(stS) ? (endS - stS) : NaN, false);

  $('metricTitle').textContent = (METRICS[currentMetric]?.name || currentMetric);

  if(currentView==='trend') ensureTrend(data);
  if(currentView==='bodymap') ensureBodyMap(data);
  if(currentView==='more') renderMore(end);
}

/* =========================
   load / refresh
   ========================= */
async function reloadRowsCore(){
  const url = `${SHEET_ENDPOINT}?action=read&token=${encodeURIComponent(SHEET_TOKEN)}`;
  const payload = await jsonpGet(url);
  if(!payload?.ok) throw new Error(payload?.error || 'bad payload');
  rows = toRowsFromSheet(payload.header, payload.rows);
  render();
}

/* 書き込み直後の読み取りは反映ズレがあるので軽くリトライ */
async function reloadRowsRetry(){
  let lastErr = null;
  for(let i=0;i<3;i++){
    try{
      await reloadRowsCore();
      return;
    }catch(e){
      lastErr = e;
      await sleep(300 + i*250);
    }
  }
  throw lastErr;
}

async function reloadRows(){
  await withBusy('Loading…', async ()=>{
    await reloadRowsRetry();
  }, 350);
}

/* =========================
   UI events
   ========================= */
document.querySelectorAll('#rangeSeg button').forEach(b=>{
  b.addEventListener('click', ()=>{
    document.querySelectorAll('#rangeSeg button').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    currentRange = b.dataset.range;
    render();
  });
});

document.querySelectorAll('#viewSeg button').forEach(b=>{
  b.addEventListener('click', ()=> setView(b.dataset.view,'direct'));
});

$('metricTabs').addEventListener('click', (e)=>{
  const tab = e.target.closest('.tab');
  if(!tab) return;
  document.querySelectorAll('#metricTabs .tab').forEach(t=>t.classList.remove('active'));
  tab.classList.add('active');
  currentMetric = tab.dataset.m;
  showMetricTabs = true;
  setView('trend','direct');
});

/* ロゴ押下で更新（Loadingに戻す演出） */
$('logoBtn').addEventListener('click', async ()=>{
  await reloadRows();
});

/* =========================
   modals
   ========================= */
function openModal(bg){ bg.style.display='flex'; }
function closeModal(bg){ bg.style.display='none'; }
function closeOnBg(bg){
  bg.addEventListener('click', (e)=>{ if(e.target===bg) closeModal(bg); });
}
const targetsBg = $('modalTargetsBg');
const addBg     = $('modalAddBg');
const listBg    = $('modalListBg');
closeOnBg(targetsBg);
closeOnBg(addBg);
closeOnBg(listBg);

/* ===== Targets ===== */
$('openTargets').onclick = ()=>{
  $('t_weight').value = Number.isFinite(targets.weight_kg)?targets.weight_kg.toFixed(1):'';
  $('t_bf').value     = Number.isFinite(targets.bodyfat_pct)?targets.bodyfat_pct.toFixed(1):'';
  $('t_fm').value     = Number.isFinite(targets.fatmass_kg)?targets.fatmass_kg.toFixed(1):'';
  $('t_smm').value    = Number.isFinite(targets.skeletal_muscle_kg)?targets.skeletal_muscle_kg.toFixed(1):'';
  $('t_height').value = targets.height_cm ? String(targets.height_cm) : '';
  openModal(targetsBg);
};
$('closeTargets').onclick = ()=> closeModal(targetsBg);

$('saveTargets').onclick = ()=>{
  const w  = parseFloat($('t_weight').value);
  const bf = parseFloat($('t_bf').value);
  const fm = parseFloat($('t_fm').value);
  const smm= parseFloat($('t_smm').value);
  const h  = parseFloat($('t_height').value);

  if(!Number.isNaN(w))   targets.weight_kg = w;
  if(!Number.isNaN(bf))  targets.bodyfat_pct = bf;
  if(!Number.isNaN(fm))  targets.fatmass_kg = fm;
  if(!Number.isNaN(smm)) targets.skeletal_muscle_kg = smm;
  targets.height_cm = (!Number.isNaN(h) && h>0) ? h : null;

  saveTargets();
  closeModal(targetsBg);

  if(trendChart) trendChart.update();
  if(bodyMapChart) bodyMapChart.update();
  render();
};

/* ===== add/edit ===== */
function resetForm(){
  $('a_date').value = '';
  $('a_weight').value = '';
  $('a_bf').value = '';
  $('a_fm').value = '';
  $('a_smm').value = '';
  $('a_mu').value = '';
  $('a_vfl').value = '';
  $('a_bmi').value = '';
}

function openAdd(){
  editMode = false;
  editOriginalDate = null;
  $('addTitle').textContent = 'データ追加';
  $('deleteOne').style.display = 'none';
  resetForm();
  openModal(addBg);
}
function openEdit(row){
  editMode = true;
  editOriginalDate = row.date;
  $('addTitle').textContent = 'データ更新';
  $('deleteOne').style.display = 'inline-block';

  $('a_date').value   = row.date || '';
  $('a_weight').value = row.weight_kg ?? '';
  $('a_bf').value     = row.bodyfat_pct ?? '';
  $('a_fm').value     = row.fatmass_kg ?? '';
  $('a_smm').value    = row.skeletal_muscle_kg ?? '';
  $('a_mu').value     = row.muscle_kg ?? '';
  $('a_vfl').value    = row.visceral_fat_level ?? '';
  $('a_bmi').value    = row.bmi ?? '';

  openModal(addBg);
}

$('openAdd').onclick = openAdd;
$('closeAdd').onclick = ()=> closeModal(addBg);

$('saveAdd').onclick = async ()=>{
  const date = normalizeYMD($('a_date').value || '');
  const weight = parseFloat($('a_weight').value);
  const bf = parseFloat($('a_bf').value);
  const fm = parseFloat($('a_fm').value);
  const smm = parseFloat($('a_smm').value);

  const mu  = parseFloat($('a_mu').value);
  const vfl = parseFloat($('a_vfl').value);
  let bmi = parseFloat($('a_bmi').value);

  if(!date){ alert('測定日を選んでね'); return; }
  if([weight,bf,fm,smm].some(x=>Number.isNaN(x))){
    alert('必須が足りないよ（体重/体脂肪率/体脂肪量/骨格筋量）');
    return;
  }

  if(Number.isNaN(bmi)){
    const calc = computeBmiFromHeight(weight);
    if(calc===null){
      alert('BMIが空なら、目標設定で身長(cm)を入れてね（自動計算する）');
      return;
    }
    bmi = calc;
  }

  try{
    await withBusy('Saving…', async ()=>{
      if(editMode && editOriginalDate && editOriginalDate !== date){
        await postToGAS({ action:'delete', date: normalizeYMD(editOriginalDate) });
        await sleep(200);
      }

      await postToGAS({
        action:'upsert',
        date,
        weight_kg: weight,
        bodyfat_pct: bf,
        bmi: bmi,
        fitness_score: '',
        fatmass_kg: fm,
        muscle_kg: Number.isNaN(mu) ? '' : mu,
        skeletal_muscle_kg: smm,
        visceral_fat_level: Number.isNaN(vfl) ? '' : vfl
      });

      // 反映ズレ吸収
      await sleep(450);
      await reloadRowsRetry();
    }, 450);

    editMode = false;
    editOriginalDate = null;
    closeModal(addBg);
  }catch(e){
    console.error(e);
    alert('保存に失敗しました（GASのTOKEN/デプロイ/権限を確認）');
  }
};

$('deleteOne').onclick = async ()=>{
  if(!editMode || !editOriginalDate) return;
  if(!confirm(`${editOriginalDate} のデータを削除する？`)) return;

  try{
    await withBusy('Deleting…', async ()=>{
      await postToGAS({ action:'delete', date: normalizeYMD(editOriginalDate) });
      await sleep(450);
      await reloadRowsRetry();
    }, 450);

    editMode = false;
    editOriginalDate = null;
    closeModal(addBg);
  }catch(e){
    console.error(e);
    alert('削除に失敗しました');
  }
};

/* ===== list ===== */
$('closeList').onclick = ()=> closeModal(listBg);

function renderList(){
  const data = filt().slice().sort((a,b)=>b.date.localeCompare(a.date));
  const wrap = $('listWrap');
  wrap.innerHTML = '';
  for(const r of data){
    const div = document.createElement('div');
    div.className = 'listRow';
    const w = getMetricValue(r,'weight_kg');
    const bf = getMetricValue(r,'bodyfat_pct');
    const fm = getMetricValue(r,'fatmass_kg');
    const smm = getMetricValue(r,'skeletal_muscle_kg');

    div.innerHTML = `
      <div class="listMain">
        <div class="listDate">${r.date}</div>
        <div class="listSub">${fmt1(w)}kg / ${fmt1(bf)}% / 脂肪${fmt1(fm)}kg / 骨格筋${fmt1(smm)}kg</div>
      </div>
      <div class="listActions"><button class="listEdit">更新</button></div>
    `;
    div.querySelector('.listEdit').onclick = ()=>{
      closeModal(listBg);
      openEdit(r);
    };
    wrap.appendChild(div);
  }
}
$('countChip').onclick = ()=>{
  renderList();
  openModal(listBg);
};

/* =========================
   CSV export/import (client)
   ========================= */
function exportCsv(){
  if(!rows.length){ alert('データがありません'); return; }

  const header = ['date','weight_kg','bodyfat_pct','bmi','fitness_score','fatmass_kg','muscle_kg','skeletal_muscle_kg','visceral_fat_level'];
  let csv = header.join(',') + '\n';

  for(const r of rows){
    const line = [
      normalizeYMD(r.date),
      r.weight_kg ?? '',
      r.bodyfat_pct ?? '',
      r.bmi ?? '',
      r.fitness_score ?? '',
      r.fatmass_kg ?? '',
      r.muscle_kg ?? '',
      r.skeletal_muscle_kg ?? '',
      r.visceral_fat_level ?? ''
    ].map(x => (x ?? '')).join(',');
    csv += line + '\n';
  }

  const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'progressfit_data.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

async function handleImportFiles(files){
  const file = files && files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = async (evt)=>{
    try{
      const text = String(evt.target.result || '').trim();
      if(!text){ alert('ファイルが空です'); return; }

      await withBusy('Importing…', async ()=>{
        await postToGAS({ action:'import', mode:'replace', csv:text });
        await sleep(600);
        await reloadRowsRetry();
      }, 450);

      alert('インポート完了（Sheet全置換）');
    }catch(err){
      console.error(err);
      alert('インポート失敗（ヘッダ/形式を確認）');
    }
  };
  reader.readAsText(file);
}

$('exportCsvBtn').addEventListener('click', exportCsv);
$('importCsvBtn').addEventListener('click', ()=>{
  const input = $('importCsvInput');
  input.value = '';
  input.click();
});
$('importCsvInput').addEventListener('change', (e)=>{
  handleImportFiles(e.target.files);
});

/* =========================
   PDF export
   ========================= */
async function exportPdf() {
  try{
    const { jsPDF } = window.jspdf || {};
    if(!jsPDF){
      alert('PDFライブラリの読み込みに失敗しました');
      return;
    }
    if(!rows.length){
      alert('出力するデータがありません');
      return;
    }

    await withBusy('Generating PDF…', async ()=>{
      const all = rows.slice();
      const endDate = parseDateLocal(all.at(-1).date);
      const startDate = new Date(endDate);
      startDate.setFullYear(startDate.getFullYear() - 1);
      const rows1y = all.filter(r => {
        const d = parseDateLocal(r.date);
        return d && d >= startDate;
      });
      if(!rows1y.length){
        alert('出力するデータがありません');
        return;
      }

      const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });

      async function createTextImage(text, fontSize, width, height) {
        const c = document.createElement('canvas');
        c.width = width;
        c.height = height;
        const ctx = c.getContext('2d');
        ctx.fillStyle = '#0D2340';
        ctx.fillRect(0, 0, c.width, c.height);
        ctx.fillStyle = '#ffffff';
        ctx.font = `${fontSize}px sans-serif`;
        ctx.textBaseline = 'middle';
        ctx.fillText(text, 8, height / 2);
        return c.toDataURL('image/png');
      }

      async function createChartImage(metricKey) {
        return new Promise((resolve) => {
          const canvas = document.createElement('canvas');
          canvas.width = 600;
          canvas.height = 300;
          const ctx = canvas.getContext('2d');
          ctx.fillStyle = '#0D2340';
          ctx.fillRect(0, 0, canvas.width, canvas.height);

          const labels = rows1y.map(r => r.date);
          const values = rows1y.map(r => getMetricValue(r, metricKey));

          const chart = new Chart(ctx, {
            type: 'line',
            data: {
              labels,
              datasets: [{
                data: values,
                fill: false,
                tension: 0.2,
                borderWidth: 2,
                pointRadius: 0,
                spanGaps: true
              }]
            },
            options: {
              responsive: false,
              maintainAspectRatio: false,
              plugins: { legend: { display:false }, tooltip:{ enabled:false } },
              scales: {
                x: { ticks: { autoSkip:true, maxTicksLimit:6, color:'#ffffff' }, grid:{ color:'rgba(255,255,255,0.1)' } },
                y: { ticks: { color:'#ffffff' }, grid:{ color:'rgba(255,255,255,0.1)' } }
              }
            }
          });

          setTimeout(() => {
            const img = chart.toBase64Image();
            chart.destroy();
            resolve(img);
          }, 100);
        });
      }

      const from = rows1y[0].date;
      const to = rows1y.at(-1).date;

      const titleImg = await createTextImage('ProgressFit レポート', 20, 600, 40);
      const periodImg = await createTextImage(`期間: ${from} ～ ${to} (直近1年)`, 12, 600, 30);

      const metricsToExport = [...MAIN_METRICS, ...getMoreMetrics()];
      let first = true;

      for(const m of metricsToExport){
        const mDef = METRICS[m];
        const imgData = await createChartImage(m);

        if(first){
          doc.setFillColor(13, 35, 64);
          doc.rect(0, 0, 210, 297, 'F');
          doc.addImage(titleImg, 'PNG', 10, 10, 190, 15);
          doc.addImage(periodImg, 'PNG', 10, 27, 190, 10);

          const metricTitleImg = await createTextImage(mDef.name, 14, 600, 25);
          doc.addImage(metricTitleImg, 'PNG', 10, 40, 190, 10);
          doc.addImage(imgData, 'PNG', 10, 50, 190, 100);
          first = false;
        }else{
          doc.addPage();
          doc.setFillColor(13, 35, 64);
          doc.rect(0, 0, 210, 297, 'F');
          const metricTitleImg = await createTextImage(mDef.name, 14, 600, 25);
          doc.addImage(metricTitleImg, 'PNG', 10, 10, 190, 10);
          doc.addImage(imgData, 'PNG', 10, 20, 190, 100);
        }
      }

      doc.save('progressfit_report.pdf');
    }, 450);

  }catch(err){
    console.error(err);
    alert('PDF生成に失敗しました');
  }
}
$('exportPdfBtn').addEventListener('click', exportPdf);

/* =========================
   init
   ========================= */
reloadRows();
</script>
</body>
</html>
